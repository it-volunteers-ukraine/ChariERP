name: "CodeQL Analysis"

on:
  workflow_call:
    inputs:
      working-directory:
        required: true
        type: string
        description: 'Working directory for the analysis'
      workspace-name:
        required: true
        type: string
        description: 'NPM workspace name'
      node-version:
        required: false
        type: string
        default: '22'
        description: 'Node.js version to use'

jobs:
  analyze:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ['javascript-typescript']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          queries: security-and-quality
          config: |
            paths:
              - ${{ inputs.working-directory }}
            paths-ignore:
              - ${{ inputs.working-directory }}/node_modules
              - ${{ inputs.working-directory }}/dist
              - ${{ inputs.working-directory }}/.next
              - ${{ inputs.working-directory }}/coverage
              - "**/*.test.ts"
              - "**/*.spec.ts"
              - "**/*.test.js"
              - "**/*.spec.js"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            ${{ inputs.working-directory }}/package-lock.json

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
            ${{ inputs.working-directory }}/node_modules
          key: ${{ runner.os }}-node-${{ inputs.node-version }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ inputs.node-version }}-
            ${{ runner.os }}-node-

      - name: Install root dependencies
        run: npm ci --include=optional
        env:
          NODE_ENV: development

      - name: Install workspace dependencies
        working-directory: ${{ inputs.working-directory }}
        run: npm ci --include=optional --ignore-scripts
        env:
          NODE_ENV: development

      - name: Build workspace
        run: npm run build --workspace ${{ inputs.workspace-name }}
        env:
          NODE_ENV: production

      - name: Run tests (if available)
        run: |
          if npm run test --workspace ${{ inputs.workspace-name }} --if-present; then
            echo "Tests completed successfully"
          else
            echo "No tests found or tests failed, continuing with analysis"
          fi
        continue-on-error: true

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{ matrix.language }}/workspace:${{ inputs.workspace-name }}"
          upload: true
