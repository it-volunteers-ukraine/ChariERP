name: "Deploy Full Stack to Digital Ocean"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      deploy-backend:
        description: 'Deploy backend'
        required: true
        default: true
        type: boolean
      deploy-frontend:
        description: 'Deploy frontend'
        required: true
        default: true
        type: boolean

jobs:
  deploy-backend:
    if: ${{ inputs.deploy-backend }}
    name: Deploy Backend
    uses: ./.github/workflows/digitalocean-deploy.yml
    with:
      working-directory: ./server
      container-name: charierp-server
      dockerfile-path: ./server/Dockerfile
      workspace-name: server
      environment: ${{ inputs.environment }}
    secrets:
      do-access-token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
      telegram-to: ${{ secrets.TELEGRAM_TO }}
      telegram-token: ${{ secrets.TELEGRAM_TOKEN }}
    permissions:
      id-token: write
      contents: read

  deploy-frontend:
    if: ${{ inputs.deploy-frontend }}
    name: Deploy Frontend
    uses: ./.github/workflows/digitalocean-deploy.yml
    with:
      working-directory: ./client
      container-name: charierp-client
      dockerfile-path: ./client/Dockerfile
      workspace-name: client
      environment: ${{ inputs.environment }}
    secrets:
      do-access-token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
      telegram-to: ${{ secrets.TELEGRAM_TO }}
      telegram-token: ${{ secrets.TELEGRAM_TOKEN }}
    permissions:
      id-token: write
      contents: read
