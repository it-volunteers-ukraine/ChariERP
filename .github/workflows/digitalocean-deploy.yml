name: "DigitalOcean Deployment"

on:
  workflow_call:
    inputs:
      working-directory:
        required: true
        type: string
        description: 'Working directory for the build'
      container-name:
        required: true
        type: string
        description: 'Container name for the image'
      dockerfile-path:
        required: true
        type: string
        description: 'Path to the Dockerfile'
      workspace-name:
        required: true
        type: string
        description: 'NPM workspace name'
      environment:
        required: false
        type: string
        default: 'production'
        description: 'Deployment environment'
      log-level:
        required: false
        type: string
        default: 'info'
        description: 'Log level for deployment'
      node-version:
        required: false
        type: string
        default: '22'
        description: 'Node.js version'
    secrets:
      do-access-token:
        required: true
      telegram-to:
        required: true
      telegram-token:
        required: true

env:
  DO_REGISTRY: it-volunteers-ukraine
  DO_REPOSITORY: chari_erp_repository
  CONTAINER_NAME: ${{ inputs.container-name }}
  ENVIRONMENT: ${{ inputs.environment }}

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    timeout-minutes: 30

    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-${{ inputs.container-name }}-${{ inputs.environment }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-${{ inputs.container-name }}-${{ inputs.environment }}-
            ${{ runner.os }}-${{ inputs.container-name }}-

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.do-access-token }}

      - name: Log in to DigitalOcean Registry
        run: doctl registry login --expiry-seconds 1200

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: registry.digitalocean.com/${{ env.DO_REGISTRY }}/${{ env.DO_REPOSITORY }}
          tags: |
            type=raw,value=${{ env.CONTAINER_NAME }}
            type=raw,value=${{ env.CONTAINER_NAME }}-${{ env.ENVIRONMENT }}
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=${{ env.CONTAINER_NAME }}-latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ inputs.working-directory }}
          file: ${{ inputs.dockerfile-path }}
          push: true
          tags: |
            registry.digitalocean.com/${{ env.DO_REGISTRY }}/${{ env.DO_REPOSITORY }}:${{ env.CONTAINER_NAME }}
            ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          build-args: |
            NODE_VERSION=${{ inputs.node-version }}
            ENVIRONMENT=${{ inputs.environment }}

      - name: Show image tags
        run: echo "${{ steps.meta.outputs.tags }}"

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Verify deployment
        run: |
          echo "ğŸš€ Deployment completed successfully!"
          echo "ğŸ“¦ Image: registry.digitalocean.com/${{ env.DO_REGISTRY }}/${{ env.DO_REPOSITORY }}:${{ env.CONTAINER_NAME }}-${{ env.ENVIRONMENT }}"
          echo "ğŸ·ï¸ Tags: ${{ steps.meta.outputs.tags }}"

  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [ build-and-deploy ]
    if: always()
    
    steps:
      - name: Get commit info
        id: commit
        run: |
          echo "author=${{ github.event.head_commit.author.name || github.actor }}" >> $GITHUB_OUTPUT
          echo "message=${{ github.event.head_commit.message || 'Manual deployment' }}" >> $GITHUB_OUTPUT

      - name: Send success notification
        if: needs.build-and-deploy.result == 'success'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.telegram-to }}
          token: ${{ secrets.telegram-token }}
          format: html
          message: |
            ğŸš€ <b>ChariERP Deployment Success</b> ğŸ‰

            ${{ inputs.container-name == 'chari_erp_ui' && 'ğŸ’» <b>Frontend</b>' || 'âš™ï¸ <b>Backend</b>' }} deployed to <b>${{ inputs.environment }}</b>

            <b>Details</b>:
            â€¢ ğŸŒ¿ Branch: <code>${{ github.ref_name }}</code>
            â€¢ ğŸ“¦ Commit: <code>${{ github.sha }}</code>
            â€¢ ğŸ‘¨â€ğŸ’» Author: <code>${{ steps.commit.outputs.author }}</code>
            â€¢ ğŸ’¬ Message: <code>${{ steps.commit.outputs.message }}</code>
            â€¢ ğŸ·ï¸ Container: <code>${{ inputs.container-name }}-${{ inputs.environment }}</code>

            ğŸ”— <a href="https://github.com/${{ github.repository }}/commit/${{ github.sha }}">View Changes</a>

      - name: Send failure notification
        if: needs.build-and-deploy.result == 'failure'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.telegram-to }}
          token: ${{ secrets.telegram-token }}
          format: html
          message: |
            âŒ <b>ChariERP Deployment Failed</b> ğŸ’¥
            
            ${{ inputs.container-name == 'chari_erp_ui' && 'ğŸ’» <b>Frontend</b>' || 'âš™ï¸ <b>Backend</b>' }} deployment to <b>${{ inputs.environment }}</b> failed
            
            <b>Details</b>:
            â€¢ ğŸŒ¿ Branch: <code>${{ github.ref_name }}</code>
            â€¢ ğŸ“¦ Commit: <code>${{ github.sha }}</code>
            â€¢ ğŸ‘¨â€ğŸ’» Author: <code>${{ steps.commit.outputs.author }}</code>
            
            ğŸ”— <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Logs</a>
            ğŸ”— <a href="https://github.com/${{ github.repository }}/commit/${{ github.sha }}">View Changes</a>
